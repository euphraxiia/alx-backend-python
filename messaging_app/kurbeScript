#!/usr/bin/env bash

set -euo pipefail

PROFILE="${MINIKUBE_PROFILE:-kurbe-profile}"
DRIVER="${MINIKUBE_DRIVER:-}"

log() {
  printf '[INFO] %s\n' "$*"
}

abort() {
  printf '[ERROR] %s\n' "$*" >&2
  exit 1
}

ensure_tool_present() {
  local cmd="$1"
  local install_url="$2"

  if ! command -v "$cmd" >/dev/null 2>&1; then
    abort "$cmd is not installed. Please install it first: $install_url"
  fi
}

start_minikube() {
  local args=("--profile" "$PROFILE")
  if [[ -n "$DRIVER" ]]; then
    args+=("--driver" "$DRIVER")
  fi

  log "Starting Minikube (profile: $PROFILE)..."
  minikube start "${args[@]}"
  log "Minikube is up."
}

verify_cluster() {
  log "Switching kubectl context to $PROFILE..."
  kubectl config use-context "$PROFILE"

  log "Cluster info:"
  kubectl cluster-info

  log "Available pods (all namespaces):"
  kubectl get pods --all-namespaces
}

main() {
  ensure_tool_present "minikube" "https://minikube.sigs.k8s.io/docs/start/"
  ensure_tool_present "kubectl" "https://kubernetes.io/docs/tasks/tools/"
  start_minikube
  verify_cluster
}

main "$@"

